# 项目结构设计

## 📋 本文档内容

- Cocos Creator 项目目录组织
- 场景和预制体设计
- 脚本模块划分
- 资源分类管理

---

## 1️⃣ 完整目录结构

```
proj-cocos/
├── assets/                          # 资源目录（核心开发区域）
│   │
│   ├── scenes/                      # 场景文件
│   │   ├── Game.scene              # 主游戏场景
│   │   ├── Settings.scene          # 设置场景
│   │   └── Test.scene              # 测试场景
│   │
│   ├── scripts/                     # TypeScript 脚本
│   │   │
│   │   ├── core/                   # 核心游戏逻辑
│   │   │   ├── GameManager.ts     # 游戏主控制器
│   │   │   ├── WordManager.ts     # 单词管理器
│   │   │   ├── ScoreManager.ts    # 分数和等级管理
│   │   │   ├── InputManager.ts    # 输入处理
│   │   │   └── BufferManager.ts   # 缓冲区管理
│   │   │
│   │   ├── systems/                # 游戏系统
│   │   │   ├── CannonSystem.ts    # 炮管系统
│   │   │   ├── ExplosionSystem.ts # 爆炸系统
│   │   │   ├── ParticleSystem.ts  # 粒子系统
│   │   │   └── CollisionSystem.ts # 碰撞检测
│   │   │
│   │   ├── entities/               # 游戏实体
│   │   │   ├── WordEntity.ts      # 单词实体
│   │   │   ├── CannonEntity.ts    # 炮管实体
│   │   │   ├── BulletEntity.ts    # 炮弹实体
│   │   │   └── FuseEntity.ts      # 引信实体
│   │   │
│   │   ├── ui/                     # UI 组件
│   │   │   ├── GameUI.ts          # 游戏主界面
│   │   │   ├── SettingsUI.ts      # 设置界面
│   │   │   ├── VocabularyUI.ts    # 生词本界面
│   │   │   ├── ImageShowcase.ts   # 图片展示区
│   │   │   └── DebugPanel.ts      # 调试面板
│   │   │
│   │   ├── utils/                  # 工具类
│   │   │   ├── TTSService.ts      # TTS 语音服务
│   │   │   ├── AudioCache.ts      # 音频缓存
│   │   │   ├── MissedWordsManager.ts # 生词管理
│   │   │   ├── PhoneticFormatter.ts  # 音标格式化
│   │   │   └── DebugLogger.ts     # 调试日志
│   │   │
│   │   ├── config/                 # 配置文件
│   │   │   ├── GameConfig.ts      # 游戏配置
│   │   │   ├── LevelConfig.ts     # 关卡配置
│   │   │   └── R2Config.ts        # R2 配置
│   │   │
│   │   └── types/                  # TypeScript 类型定义
│   │       ├── Word.ts            # 单词类型
│   │       ├── GameState.ts       # 游戏状态类型
│   │       └── Config.ts          # 配置类型
│   │
│   ├── prefabs/                     # 预制体
│   │   ├── entities/               # 实体预制体
│   │   │   ├── Word.prefab        # 单词预制体
│   │   │   ├── Cannon.prefab      # 炮管预制体
│   │   │   ├── Bullet.prefab      # 炮弹预制体
│   │   │   └── Explosion.prefab   # 爆炸预制体
│   │   │
│   │   ├── ui/                     # UI 预制体
│   │   │   ├── TopBar.prefab      # 顶部信息栏
│   │   │   ├── Sidebar.prefab     # 侧边栏
│   │   │   ├── ControlPanel.prefab # 控制面板
│   │   │   └── Modal.prefab       # 弹窗
│   │   │
│   │   └── effects/                # 效果预制体
│   │       ├── Particle.prefab    # 粒子效果
│   │       ├── RedCross.prefab    # 红叉标记
│   │       └── Highlight.prefab   # 高亮效果
│   │
│   ├── resources/                   # 动态加载资源
│   │   │
│   │   ├── words/                  # 单词库
│   │   │   ├── config-v2.json     # 词库配置
│   │   │   ├── daily-phonics/     # 按天学习
│   │   │   ├── special-practice/  # 专项练习
│   │   │   └── grade-based/       # 按年级
│   │   │
│   │   ├── audio/                  # 音频文件
│   │   │   ├── tts/               # TTS 缓存
│   │   │   ├── bgm/               # 背景音乐
│   │   │   └── sfx/               # 音效
│   │   │
│   │   ├── images/                 # 图片资源
│   │   │   ├── words/             # 单词图片
│   │   │   ├── ui/                # UI 图片
│   │   │   └── icons/             # 图标
│   │   │
│   │   └── fonts/                  # 字体文件
│   │       └── custom.ttf
│   │
│   ├── textures/                    # 纹理资源（编辑器引用）
│   │   ├── ui/                     # UI 纹理
│   │   ├── sprites/                # 精灵图
│   │   └── particles/              # 粒子纹理
│   │
│   └── animations/                  # 动画资源
│       ├── cannon/                 # 炮管动画
│       ├── word/                   # 单词动画
│       └── ui/                     # UI 动画
│
├── build/                           # 构建输出（自动生成，不提交）
├── library/                         # 编译缓存（自动生成，不提交）
├── temp/                            # 临时文件（自动生成，不提交）
├── local/                           # 本地配置（自动生成，不提交）
├── settings/                        # 项目设置
├── extensions/                      # 扩展插件
├── docs/                            # 文档目录
│   ├── 01_迁移总览.md
│   ├── 02_环境准备.md
│   ├── 03_项目结构设计.md
│   └── ...
├── package.json                     # npm 依赖配置
├── tsconfig.json                    # TypeScript 配置
├── project.json                     # Cocos 项目配置
├── .gitignore                       # Git 忽略配置
└── README.md                        # 项目说明
```

---

## 2️⃣ 场景设计

### 2.1 主游戏场景（Game.scene）

**节点层级结构：**

```
Canvas (根节点)
│
├── Camera (相机)
│
├── GameLayer (游戏层 - z-index: 0)
│   │
│   ├── Background (背景)
│   │   └── Sprite (深蓝色渐变)
│   │
│   ├── BufferZone (缓冲区)
│   │   ├── TrafficLights (信号灯容器)
│   │   │   ├── RedLight (红灯)
│   │   │   ├── YellowLight (黄灯)
│   │   │   └── GreenLight (绿灯)
│   │   └── NextWordLabel (下一个单词显示)
│   │
│   ├── GameZone (游戏区域)
│   │   ├── WordsContainer (单词容器)
│   │   │   └── [动态创建的 Word 节点]
│   │   │
│   │   ├── StackZone (堆叠区)
│   │   │   └── [堆叠的单词]
│   │   │
│   │   └── Cannon (炮管)
│   │       ├── Base (炮台基座 - 不旋转)
│   │       ├── Platform (炮台平台 - 旋转)
│   │       ├── Barrel (炮管主体 - 旋转)
│   │       │   ├── BarrelBack (后段)
│   │       │   ├── BarrelMiddle (中段)
│   │       │   ├── BarrelFront (前段)
│   │       │   └── Muzzle (炮口)
│   │       └── Fuse (引信 - 物理摆动)
│   │           └── FuseParticles (火焰粒子)
│   │
│   ├── EffectsLayer (效果层 - z-index: 10)
│   │   ├── BulletsContainer (炮弹容器)
│   │   ├── ExplosionsContainer (爆炸容器)
│   │   └── ParticlesContainer (粒子容器)
│   │
│   └── HighlightsLayer (高亮层 - z-index: 20)
│       ├── InputHighlight (输入高亮)
│       └── RedCrossMarks (红叉标记)
│
└── UILayer (UI层 - z-index: 100)
    │
    ├── LeftPanel (左侧面板)
    │   ├── ImageShowcase (图片展示区)
    │   │   ├── ImageFrame (图片框)
    │   │   ├── WordLabel (单词标签)
    │   │   ├── PhoneticLabel (音标标签)
    │   │   └── MeaningLabel (中文释义)
    │   │
    │   └── ControlPanel (控制面板)
    │       ├── InputBox (输入框)
    │       ├── PreviewLabel (实时预览)
    │       └── Buttons (按钮组)
    │
    ├── TopBar (顶部信息栏)
    │   ├── ScoreLabel (分数)
    │   ├── LevelLabel (等级)
    │   ├── TargetLabel (目标)
    │   ├── VocabCountLabel (单词总数)
    │   ├── TimeLabel (时间)
    │   └── ComboLabel (连击)
    │
    ├── ExamStats (考试统计栏)
    │   ├── TotalWordsLabel (剩余待测)
    │   ├── HitWordsLabel (正确命中)
    │   └── CoverageLabel (覆盖率)
    │
    ├── Sidebar (右侧边栏)
    │   ├── BufferIndicator (缓冲区指示)
    │   ├── VocabularyBook (生词本)
    │   ├── Instructions (游戏说明)
    │   └── DebugPanel (调试面板)
    │
    └── Modals (弹窗容器)
        ├── GameOverModal (游戏结束)
        ├── LevelUpModal (等级提升)
        └── SettingsModal (设置)
```

### 2.2 设置场景（Settings.scene）

**节点层级结构：**

```
Canvas
├── Camera
└── SettingsUI
    ├── Background
    ├── Title
    ├── GameModeSection (游戏模式)
    ├── VocabularySection (词库选择)
    ├── AudioSection (音频设置)
    ├── AdvancedSection (高级设置)
    └── Buttons (保存/取消)
```

---

## 3️⃣ 预制体设计

### 3.1 Word 预制体（Word.prefab）

**组件结构：**
```
Word (Node)
├── WordEntity (Script) - 单词逻辑脚本
├── Background (Sprite) - 背景框
├── LettersContainer (Node) - 字母容器
│   └── [动态创建的 Label 节点] - 每个字母
├── InputHighlight (Sprite) - 输入高亮
└── RedCross (Sprite) - 错误标记
```

**WordEntity 脚本属性：**
```typescript
@property
wordData: WordData = null; // 单词数据

@property(Node)
lettersContainer: Node = null;

@property(Prefab)
letterPrefab: Prefab = null;

@property(Sprite)
background: Sprite = null;

@property(Sprite)
highlight: Sprite = null;

@property(Sprite)
redCross: Sprite = null;
```

### 3.2 Cannon 预制体（Cannon.prefab）

**组件结构：**
```
Cannon (Node)
├── CannonEntity (Script) - 炮管逻辑
├── Base (Sprite) - 基座（不旋转）
├── RotateGroup (Node) - 旋转组
│   ├── Platform (Sprite) - 平台
│   ├── Barrel (Node) - 炮管组
│   │   ├── BarrelBack (Sprite)
│   │   ├── BarrelMiddle (Sprite)
│   │   ├── BarrelFront (Sprite)
│   │   └── Muzzle (Sprite)
│   └── Fuse (Node) - 引信
│       ├── FuseEntity (Script) - 物理摆动逻辑
│       ├── FuseLine (Graphics) - 引信绳子
│       ├── FuseGlow (Sprite) - 发光效果
│       └── FuseParticles (ParticleSystem2D) - 火焰粒子
```

### 3.3 Bullet 预制体（Bullet.prefab）

**组件结构：**
```
Bullet (Node)
├── BulletEntity (Script) - 炮弹逻辑
├── OuterGlow (Sprite) - 外层光晕（红色）
├── MiddleFire (Sprite) - 中层火球（橙色）
├── InnerCore (Sprite) - 内核（亮黄色）
├── FlameParticles (ParticleSystem2D) - 火焰纹理
└── Trail (MotionStreak) - 火焰尾迹
```

### 3.4 Explosion 预制体（Explosion.prefab）

**组件结构：**
```
Explosion (Node)
├── ExplosionEntity (Script) - 爆炸逻辑
├── Particles (ParticleSystem2D) - 多彩粒子
├── MeaningLabel (Label) - 中文翻译
└── Flash (Sprite) - 闪光效果
```

---

## 4️⃣ 脚本模块设计

### 4.1 核心模块（core/）

#### GameManager.ts（游戏主控制器）

```typescript
import { _decorator, Component, Node } from 'cc';
const { ccclass, property } = _decorator;

/**
 * 游戏主控制器
 * 负责游戏流程控制、状态管理、模块协调
 */
@ccclass('GameManager')
export class GameManager extends Component {
    // 引用其他管理器
    @property(WordManager)
    wordManager: WordManager = null;
    
    @property(ScoreManager)
    scoreManager: ScoreManager = null;
    
    @property(InputManager)
    inputManager: InputManager = null;
    
    @property(BufferManager)
    bufferManager: BufferManager = null;
    
    // 游戏状态
    private gameState: GameState = GameState.Ready;
    private isPaused: boolean = false;
    
    // 核心方法
    public startGame(): void { /* ... */ }
    public pauseGame(): void { /* ... */ }
    public resumeGame(): void { /* ... */ }
    public resetGame(): void { /* ... */ }
    public levelUp(): void { /* ... */ }
    public gameOver(): void { /* ... */ }
    
    // 生命周期
    protected onLoad(): void { /* ... */ }
    protected start(): void { /* ... */ }
    protected update(dt: number): void { /* ... */ }
}
```

#### WordManager.ts（单词管理器）

```typescript
/**
 * 单词管理器
 * 负责单词库加载、单词生成、单词移动、碰撞检测
 */
@ccclass('WordManager')
export class WordManager extends Component {
    @property(Prefab)
    wordPrefab: Prefab = null;
    
    @property(Node)
    wordsContainer: Node = null;
    
    // 单词数据
    private allWords: WordData[] = [];
    private currentWord: WordEntity = null;
    private stackedWords: WordEntity[] = [];
    
    // 核心方法
    public async loadVocabulary(): Promise<void> { /* ... */ }
    public releaseWord(): void { /* ... */ }
    public removeWord(word: WordEntity): void { /* ... */ }
    public stackWord(word: WordEntity): void { /* ... */ }
    public checkCollision(bullet: BulletEntity): WordEntity { /* ... */ }
}
```

### 4.2 系统模块（systems/）

#### CannonSystem.ts（炮管系统）

```typescript
/**
 * 炮管系统
 * 负责炮管渲染、瞄准、射击、后坐力
 */
@ccclass('CannonSystem')
export class CannonSystem extends Component {
    @property(Node)
    cannon: Node = null;
    
    @property(Node)
    rotateGroup: Node = null;
    
    @property(Prefab)
    bulletPrefab: Prefab = null;
    
    // 炮管状态
    private targetAngle: number = 0;
    private currentAngle: number = 0;
    private recoil: number = 0;
    
    // 核心方法
    public aimAt(target: Vec3): void { /* ... */ }
    public fire(): BulletEntity { /* ... */ }
    public updateRecoil(dt: number): void { /* ... */ }
}
```

#### ExplosionSystem.ts（爆炸系统）

```typescript
/**
 * 爆炸系统
 * 负责粒子爆炸、中文翻译动画
 */
@ccclass('ExplosionSystem')
export class ExplosionSystem extends Component {
    @property(Prefab)
    explosionPrefab: Prefab = null;
    
    @property(Node)
    explosionsContainer: Node = null;
    
    // 核心方法
    public createExplosion(position: Vec3, meaning: string): void { /* ... */ }
    private createParticles(position: Vec3): void { /* ... */ }
    private createMeaningAnimation(position: Vec3, meaning: string): void { /* ... */ }
}
```

### 4.3 实体模块（entities/）

#### WordEntity.ts（单词实体）

```typescript
/**
 * 单词实体
 * 单个单词的显示和交互逻辑
 */
@ccclass('WordEntity')
export class WordEntity extends Component {
    // 单词数据
    private wordData: WordData = null;
    private inputText: string = '';
    private isCorrect: boolean = false;
    
    // 视觉组件
    @property(Node)
    lettersContainer: Node = null;
    
    // 核心方法
    public init(data: WordData): void { /* ... */ }
    public updateInput(input: string): void { /* ... */ }
    public showRedCross(index: number): void { /* ... */ }
    public highlightCorrect(): void { /* ... */ }
    public fall(dt: number): void { /* ... */ }
}
```

---

## 5️⃣ 资源管理规范

### 5.1 命名规范

**文件命名：**
- 脚本文件：PascalCase（如 `GameManager.ts`）
- 场景文件：PascalCase（如 `Game.scene`）
- 预制体文件：PascalCase（如 `Word.prefab`）
- 资源文件：kebab-case（如 `word-background.png`）
- JSON 文件：kebab-case（如 `config-v2.json`）

**节点命名：**
- 容器节点：使用 `Container` 后缀（如 `WordsContainer`）
- UI 节点：使用 `UI` 后缀（如 `GameUI`）
- 组节点：使用 `Group` 后缀（如 `RotateGroup`）

### 5.2 资源引用方式

**编辑器引用（prefabs/）：**
```typescript
@property(Prefab)
wordPrefab: Prefab = null; // 在编辑器中拖拽赋值
```

**动态加载（resources/）：**
```typescript
// 加载单词库
cc.resources.load('words/day01', JsonAsset, (err, asset) => {
    if (!err) {
        const words = asset.json;
    }
});

// 加载音频
cc.resources.load('audio/tts/hello_baidu', AudioClip, (err, clip) => {
    if (!err) {
        cc.audioEngine.play(clip, false, 1.0);
    }
});

// 加载图片
cc.resources.load('images/words/hello', SpriteFrame, (err, frame) => {
    if (!err) {
        sprite.spriteFrame = frame;
    }
});
```

### 5.3 资源释放策略

```typescript
// 释放不再使用的资源
cc.resources.release('words/day01');

// 释放动态创建的节点
node.destroy();

// 对象池管理（重要！）
private bulletPool: NodePool = new NodePool();

// 获取炮弹（从对象池）
getBullet(): Node {
    let bullet = this.bulletPool.get();
    if (!bullet) {
        bullet = cc.instantiate(this.bulletPrefab);
    }
    return bullet;
}

// 回收炮弹
recycleBullet(bullet: Node): void {
    this.bulletPool.put(bullet);
}
```

---

## 6️⃣ 类型定义（types/）

### Word.ts

```typescript
/**
 * 单词数据接口
 */
export interface WordData {
    word: string;            // 单词
    phonetic: string;        // 音标
    meaning: string;         // 中文释义
    difficulty: number;      // 难度 (1-3)
    missingCount: number;    // 缺失字母数量
    missingIndices: number[]; // 缺失位置
    stressPositions: number[]; // 重音位置
}

/**
 * 单词库配置接口
 */
export interface VocabularyConfig {
    id: string;
    name: string;
    description: string;
    level: string;
    words: WordData[];
}
```

### GameState.ts

```typescript
/**
 * 游戏状态枚举
 */
export enum GameState {
    Ready = 'ready',
    Playing = 'playing',
    Paused = 'paused',
    LevelUp = 'levelup',
    GameOver = 'gameover'
}

/**
 * 游戏统计数据
 */
export interface GameStats {
    score: number;
    level: number;
    combo: number;
    totalWords: number;
    hitWords: number;
    missedWords: string[];
}
```

---

## 7️⃣ 配置文件（config/）

### GameConfig.ts

```typescript
/**
 * 游戏配置
 */
export class GameConfig {
    // 游戏区域尺寸
    static readonly CANVAS_WIDTH = 600;
    static readonly CANVAS_HEIGHT = 500;
    
    // 单词下降速度
    static readonly BASE_FALL_SPEED = 0.2; // 像素/帧
    static readonly SPEED_INCREMENT = 0.05; // 每级增加
    
    // 分数配置
    static readonly SCORE_PER_LETTER = 1;
    static readonly SHOOT_BONUS = 2;
    static readonly SPEED_BONUS_MULTIPLIER = 1.5;
    static readonly COMBO_BONUS = 1;
    
    // 等级配置
    static readonly LEVEL_THRESHOLDS = [0, 100, 200, 300, 400, 500];
    
    // 缓冲区配置
    static readonly BUFFER_COUNTDOWN_TIME = 3000; // 毫秒
    static readonly LIGHT_DURATION = 1000; // 每个灯持续时间
}
```

---

## 8️⃣ 创建步骤

### 步骤 1：创建场景

1. 打开 Cocos Creator
2. 右键 `assets` → 新建 → Scene
3. 命名为 `Game`
4. 双击打开场景

### 步骤 2：搭建基本节点

1. 在 Canvas 下创建 `GameLayer` 节点
2. 在 Canvas 下创建 `UILayer` 节点
3. 设置层级（z-index）

### 步骤 3：创建脚本

1. 右键 `assets/scripts` → 新建 → TypeScript
2. 按照上面的模块结构创建脚本文件
3. 编写基础代码框架

### 步骤 4：创建预制体

1. 在场景中搭建好节点结构
2. 拖拽节点到 `assets/prefabs/` 目录
3. 删除场景中的节点

### 步骤 5：配置组件

1. 选中节点
2. 在属性检查器中添加脚本组件
3. 拖拽引用关系

---

## 9️⃣ 验证清单

- [ ] 目录结构已创建
- [ ] 场景文件已创建
- [ ] 核心脚本框架已搭建
- [ ] 预制体已设计
- [ ] 类型定义已完成
- [ ] 配置文件已创建
- [ ] 资源目录已规划
- [ ] 命名规范已遵守
- [ ] Git 忽略配置已更新

---

**项目结构设计完成！** ✅

下一步：阅读 [04_资源迁移指南.md](./04_资源迁移指南.md)

