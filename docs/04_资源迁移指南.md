# 资源迁移指南

## 📋 本文档内容

- 单词库迁移
- 音频文件迁移
- 图片资源迁移  
- 配置文件迁移
- 资源优化建议

---

## 1️⃣ 资源清单

### 原始项目资源统计（proj/）

| 资源类型 | 数量 | 总大小（估算） | 位置 |
|---------|------|---------------|------|
| 单词库 JSON | 93 个 | ~5 MB | `proj/words/` |
| TTS 音频 MP3 | 662 个 | ~80 MB | `proj/audio/` |
| 单词图片 JPG | 699 个 | ~150 MB | `proj/images/` |
| 配置文件 | 1 个 | ~50 KB | `proj/words/config-v2.json` |

**总计：约 235 MB**

---

## 2️⃣ 单词库迁移

### 2.1 源文件位置

```
proj/words/
├── config-v2.json                   # 词库配置
├── daily-phonics/                   # 按天学习（15个文件）
│   ├── day01.json
│   ├── day02.json
│   └── ...
├── special-practice/                # 专项练习（4个文件）
│   ├── ae-practice.json
│   ├── e-practice.json
│   ├── long-o-practice.json
│   └── short-o-practice.json
└── grade-based/                     # 按年级分类（74个文件）
    ├── primary/                     # 小学（8个学期）
    ├── middle/                      # 初中（6个学期）
    └── high/                        # 高中（6个学期）
```

### 2.2 目标位置

```
proj-cocos/assets/resources/words/
├── config-v2.json
├── daily-phonics/
│   ├── day01.json
│   └── ...
├── special-practice/
│   └── ...
└── grade-based/
    ├── primary/
    ├── middle/
    └── high/
```

### 2.3 迁移步骤

#### 方法一：手动复制（简单直接）

```bash
# Windows 命令行
cd D:\workspace\WordPractice

# 复制整个 words 目录
xcopy proj\words proj-cocos\assets\resources\words\ /E /I /Y

# 或使用文件管理器直接拖拽复制
```

#### 方法二：使用脚本（推荐）

创建 `tools/migrate-resources.js`：

```javascript
const fs = require('fs-extra');
const path = require('path');

// 源目录和目标目录
const SRC_WORDS = path.join(__dirname, '../../proj/words');
const DEST_WORDS = path.join(__dirname, '../assets/resources/words');

async function migrateWords() {
    console.log('开始迁移单词库...');
    
    try {
        // 确保目标目录存在
        await fs.ensureDir(DEST_WORDS);
        
        // 复制所有文件
        await fs.copy(SRC_WORDS, DEST_WORDS, {
            overwrite: true,
            filter: (src) => {
                // 只复制 JSON 文件
                return src.endsWith('.json') || fs.statSync(src).isDirectory();
            }
        });
        
        console.log('✅ 单词库迁移完成！');
        console.log(`   源目录: ${SRC_WORDS}`);
        console.log(`   目标目录: ${DEST_WORDS}`);
        
        // 统计文件数量
        const files = await fs.readdir(DEST_WORDS);
        console.log(`   文件数量: ${files.length}`);
        
    } catch (error) {
        console.error('❌ 迁移失败:', error);
    }
}

// 执行迁移
migrateWords();
```

运行脚本：

```bash
cd proj-cocos/tools
node migrate-resources.js
```

### 2.4 验证单词库

在 Cocos Creator 中验证：

```typescript
// 创建测试脚本 TestWords.ts
import { _decorator, Component, JsonAsset } from 'cc';
import { resources } from 'cc';
const { ccclass } = _decorator;

@ccclass('TestWords')
export class TestWords extends Component {
    start() {
        // 测试加载配置文件
        resources.load('words/config-v2', JsonAsset, (err, asset) => {
            if (err) {
                console.error('❌ 配置文件加载失败:', err);
                return;
            }
            console.log('✅ 配置文件加载成功:', asset.json);
        });
        
        // 测试加载单词库
        resources.load('words/daily-phonics/day01', JsonAsset, (err, asset) => {
            if (err) {
                console.error('❌ 单词库加载失败:', err);
                return;
            }
            console.log('✅ 单词库加载成功:', asset.json);
            console.log(`   单词数量: ${asset.json.words.length}`);
        });
    }
}
```

---

## 3️⃣ 音频文件迁移

### 3.1 源文件位置

```
proj/audio/
├── hello_baidu.mp3
├── world_youdao.mp3
└── ... (662个文件)
```

### 3.2 目标位置

```
proj-cocos/assets/resources/audio/tts/
├── hello_baidu.mp3
├── world_youdao.mp3
└── ...
```

### 3.3 迁移步骤

```bash
# Windows 命令行
xcopy proj\audio proj-cocos\assets\resources\audio\tts\ /E /I /Y
```

### 3.4 音频优化建议

**问题：音频文件过多过大（662个，约80MB）**

**解决方案：**

#### 方案一：保留本地缓存，动态下载（推荐）

```typescript
/**
 * 音频缓存管理器（适配 Cocos Creator）
 */
export class AudioCacheManager {
    // 检查本地缓存
    static async hasLocalCache(word: string, provider: string): Promise<boolean> {
        const path = `audio/tts/${word}_${provider}`;
        return new Promise((resolve) => {
            resources.load(path, AudioClip, (err) => {
                resolve(!err);
            });
        });
    }
    
    // 从网络下载并缓存
    static async downloadAndCache(word: string, provider: string, url: string): Promise<AudioClip> {
        // 使用 TTS 服务下载音频
        // 保存到 IndexedDB 或 localStorage
        // 返回 AudioClip
    }
}
```

#### 方案二：只迁移常用单词音频

```javascript
// 工具脚本：只复制前100个高频单词的音频
const COMMON_WORDS = ['hello', 'world', 'good', ...]; // 前100个

for (const word of COMMON_WORDS) {
    // 复制该单词的所有 TTS 提供商音频
    const files = fs.readdirSync('proj/audio');
    const wordFiles = files.filter(f => f.startsWith(`${word}_`));
    
    for (const file of wordFiles) {
        fs.copyFileSync(
            `proj/audio/${file}`,
            `proj-cocos/assets/resources/audio/tts/${file}`
        );
    }
}
```

#### 方案三：远程加载（Web 平台）

```typescript
/**
 * 使用 Cloudflare R2 或其他 CDN 存储音频
 */
export class RemoteAudioLoader {
    private static R2_BASE_URL = 'https://your-r2-url.com/audio/';
    
    static async loadAudio(word: string, provider: string): Promise<AudioClip> {
        const url = `${this.R2_BASE_URL}${word}_${provider}.mp3`;
        
        return new Promise((resolve, reject) => {
            assetManager.loadRemote(url, { ext: '.mp3' }, (err, clip: AudioClip) => {
                if (err) {
                    reject(err);
                } else {
                    resolve(clip);
                }
            });
        });
    }
}
```

### 3.5 音频加载策略

**推荐策略：三级降级**

```typescript
async loadWordAudio(word: string, provider: string): Promise<AudioClip> {
    // 1. 优先级1：本地资源
    const localPath = `audio/tts/${word}_${provider}`;
    let clip = await this.loadLocal(localPath);
    if (clip) return clip;
    
    // 2. 优先级2：IndexedDB 缓存
    clip = await AudioCacheManager.getCache(word, provider);
    if (clip) return clip;
    
    // 3. 优先级3：网络下载
    const url = this.getTTSUrl(word, provider);
    clip = await RemoteAudioLoader.loadAudio(word, provider);
    
    // 保存到缓存
    await AudioCacheManager.saveCache(word, provider, clip);
    
    return clip;
}
```

---

## 4️⃣ 图片资源迁移

### 4.1 源文件位置

```
proj/images/
├── hello.jpg
├── world.jpg
└── ... (699个文件，约150MB)
```

### 4.2 目标位置

```
proj-cocos/assets/resources/images/words/
├── hello.jpg
├── world.jpg
└── ...
```

### 4.3 图片优化方案

**问题：图片过多过大（699个，约150MB）**

**解决方案：**

#### 方案一：压缩图片

```javascript
// 使用 imagemin 压缩工具
const imagemin = require('imagemin');
const imageminJpegRecompress = require('imagemin-jpeg-recompress');

async function compressImages() {
    await imagemin(['proj/images/*.jpg'], {
        destination: 'proj-cocos/assets/resources/images/words',
        plugins: [
            imageminJpegRecompress({
                quality: 'medium',  // 质量设置
                max: 200,           // 最大尺寸 200x200
                min: 200
            })
        ]
    });
}
```

#### 方案二：转换为 WebP（更小）

```javascript
const sharp = require('sharp');
const fs = require('fs-extra');
const path = require('path');

async function convertToWebP() {
    const files = await fs.readdir('proj/images');
    
    for (const file of files) {
        if (file.endsWith('.jpg') || file.endsWith('.jpeg')) {
            const inputPath = path.join('proj/images', file);
            const outputPath = path.join(
                'proj-cocos/assets/resources/images/words',
                file.replace(/\.jpe?g$/, '.webp')
            );
            
            await sharp(inputPath)
                .resize(200, 200, { fit: 'cover' })
                .webp({ quality: 80 })
                .toFile(outputPath);
            
            console.log(`✅ 转换完成: ${file} → ${path.basename(outputPath)}`);
        }
    }
}
```

#### 方案三：远程加载（推荐）

```typescript
/**
 * 图片远程加载器
 */
export class ImageLoader {
    private static UNSPLASH_API = 'https://source.unsplash.com/200x200/?';
    private static R2_BASE_URL = 'https://your-r2-url.com/images/';
    
    /**
     * 三级降级加载策略
     */
    static async loadWordImage(word: string): Promise<SpriteFrame> {
        // 1. 本地资源
        let frame = await this.loadLocal(word);
        if (frame) return frame;
        
        // 2. R2 远程存储
        frame = await this.loadFromR2(word);
        if (frame) return frame;
        
        // 3. Unsplash API
        frame = await this.loadFromUnsplash(word);
        return frame;
    }
    
    private static async loadLocal(word: string): Promise<SpriteFrame> {
        return new Promise((resolve, reject) => {
            resources.load(`images/words/${word}`, SpriteFrame, (err, frame) => {
                if (err) reject(err);
                else resolve(frame);
            });
        });
    }
    
    private static async loadFromR2(word: string): Promise<SpriteFrame> {
        const url = `${this.R2_BASE_URL}${word}.jpg`;
        return this.loadRemote(url);
    }
    
    private static async loadFromUnsplash(word: string): Promise<SpriteFrame> {
        const url = `${this.UNSPLASH_API}${word}`;
        return this.loadRemote(url);
    }
    
    private static async loadRemote(url: string): Promise<SpriteFrame> {
        return new Promise((resolve, reject) => {
            assetManager.loadRemote(url, (err, texture: Texture2D) => {
                if (err) {
                    reject(err);
                } else {
                    const frame = new SpriteFrame();
                    frame.texture = texture;
                    resolve(frame);
                }
            });
        });
    }
}
```

### 4.4 建议策略

**对于图片资源，推荐采用混合策略：**

1. **常用单词图片**（前50-100个）：打包到本地
2. **其他单词图片**：远程加载 + 缓存
3. **占位符**：本地内置简单占位图

---

## 5️⃣ 配置文件迁移

### 5.1 词库配置

```bash
# 复制配置文件
copy proj\words\config-v2.json proj-cocos\assets\resources\words\config-v2.json
```

### 5.2 游戏配置

**原始配置**（分散在多个文件中）需要整合：

创建 `assets/resources/config/game-config.json`：

```json
{
    "version": "1.0.0",
    "game": {
        "canvasWidth": 600,
        "canvasHeight": 500,
        "baseFallSpeed": 0.2,
        "speedIncrement": 0.05
    },
    "score": {
        "scorePerLetter": 1,
        "shootBonus": 2,
        "speedBonusMultiplier": 1.5,
        "comboBonus": 1,
        "perfectBonus": 20
    },
    "levels": {
        "thresholds": [0, 100, 200, 300, 400, 500, 600, 700, 800, 900, 1000]
    },
    "buffer": {
        "countdownTime": 3000,
        "lightDuration": 1000
    },
    "audio": {
        "ttsProviders": ["baidu", "youdao", "bing", "webspeech"],
        "cacheEnabled": true,
        "repeatInterval": 5000
    }
}
```

### 5.3 R2 配置

创建 `assets/scripts/config/R2Config.ts`：

```typescript
export class R2Config {
    // Cloudflare R2 配置
    static readonly ENABLED = true;
    static readonly BASE_URL = 'https://your-domain.com/';
    
    // 资源路径
    static readonly AUDIO_PATH = 'audio/';
    static readonly IMAGE_PATH = 'images/';
    
    // 缓存策略
    static readonly CACHE_ENABLED = true;
    static readonly CACHE_DURATION = 7 * 24 * 60 * 60 * 1000; // 7天
}
```

---

## 6️⃣ 资源加载封装

### 6.1 统一资源管理器

创建 `assets/scripts/utils/ResourceManager.ts`：

```typescript
import { _decorator, resources, JsonAsset, AudioClip, SpriteFrame } from 'cc';

/**
 * 统一资源管理器
 * 封装所有资源加载逻辑
 */
export class ResourceManager {
    // 单例模式
    private static _instance: ResourceManager = null;
    
    public static getInstance(): ResourceManager {
        if (!this._instance) {
            this._instance = new ResourceManager();
        }
        return this._instance;
    }
    
    /**
     * 加载单词库配置
     */
    public async loadVocabularyConfig(): Promise<any> {
        return this.loadJSON('words/config-v2');
    }
    
    /**
     * 加载单词库
     */
    public async loadVocabulary(libraryId: string): Promise<any> {
        return this.loadJSON(`words/${libraryId}`);
    }
    
    /**
     * 加载单词音频
     */
    public async loadWordAudio(word: string, provider: string): Promise<AudioClip> {
        const path = `audio/tts/${word}_${provider}`;
        
        return new Promise((resolve, reject) => {
            resources.load(path, AudioClip, (err, clip) => {
                if (err) {
                    // 降级到网络加载
                    this.loadRemoteAudio(word, provider)
                        .then(resolve)
                        .catch(reject);
                } else {
                    resolve(clip);
                }
            });
        });
    }
    
    /**
     * 加载单词图片
     */
    public async loadWordImage(word: string): Promise<SpriteFrame> {
        const path = `images/words/${word}`;
        
        return new Promise((resolve, reject) => {
            resources.load(path, SpriteFrame, (err, frame) => {
                if (err) {
                    // 降级到网络加载
                    this.loadRemoteImage(word)
                        .then(resolve)
                        .catch(reject);
                } else {
                    resolve(frame);
                }
            });
        });
    }
    
    /**
     * 加载 JSON 资源
     */
    private loadJSON(path: string): Promise<any> {
        return new Promise((resolve, reject) => {
            resources.load(path, JsonAsset, (err, asset) => {
                if (err) {
                    reject(err);
                } else {
                    resolve(asset.json);
                }
            });
        });
    }
    
    /**
     * 远程加载音频（降级方案）
     */
    private async loadRemoteAudio(word: string, provider: string): Promise<AudioClip> {
        // 实现网络加载逻辑
        // ...
        return null;
    }
    
    /**
     * 远程加载图片（降级方案）
     */
    private async loadRemoteImage(word: string): Promise<SpriteFrame> {
        // 实现网络加载逻辑
        // ...
        return null;
    }
    
    /**
     * 释放资源
     */
    public releaseAsset(path: string): void {
        resources.release(path);
    }
    
    /**
     * 释放所有资源
     */
    public releaseAll(): void {
        resources.releaseAll();
    }
}
```

---

## 7️⃣ 迁移验证清单

### 单词库验证

- [ ] `config-v2.json` 可以加载
- [ ] `daily-phonics/` 目录下所有文件可以加载
- [ ] `special-practice/` 目录下所有文件可以加载
- [ ] `grade-based/` 目录下所有文件可以加载
- [ ] 单词数据结构正确（word、phonetic、meaning 等字段）

### 音频验证

- [ ] 至少10个常用单词的音频可以播放
- [ ] 音频缓存系统工作正常
- [ ] 远程加载降级方案工作正常
- [ ] TTS 服务集成正常

### 图片验证

- [ ] 至少10个常用单词的图片可以显示
- [ ] 图片加载速度可接受（< 2秒）
- [ ] 占位符显示正常
- [ ] 远程加载降级方案工作正常

### 配置验证

- [ ] 游戏配置可以加载
- [ ] R2 配置正确（如果使用）
- [ ] 所有配置参数有效

---

## 8️⃣ 性能优化建议

### 资源预加载

```typescript
/**
 * 预加载管理器
 */
export class PreloadManager {
    /**
     * 预加载关键资源
     */
    public async preloadEssentials(): Promise<void> {
        const tasks = [
            // 预加载配置
            this.preloadConfigs(),
            // 预加载前50个单词库
            this.preloadCommonWords(),
            // 预加载常用音频
            this.preloadCommonAudio(),
            // 预加载常用图片
            this.preloadCommonImages()
        ];
        
        await Promise.all(tasks);
    }
    
    private async preloadCommonWords(): Promise<void> {
        const commonLibraries = ['day01', 'day02', 'day03'];
        
        for (const lib of commonLibraries) {
            await ResourceManager.getInstance().loadVocabulary(lib);
        }
    }
}
```

### 资源压缩

- 音频：使用 MP3 128kbps 或更低码率
- 图片：使用 WebP 格式，质量 80%
- JSON：压缩去除空格和换行

### 延迟加载

```typescript
/**
 * 延迟加载策略
 */
export class LazyLoadManager {
    /**
     * 延迟加载非关键资源
     */
    public async lazyLoadAssets(): Promise<void> {
        // 游戏开始后再加载
        setTimeout(() => {
            this.loadExtraVocabularies();
            this.loadExtraImages();
        }, 5000);
    }
}
```

---

## 9️⃣ 常见问题

### Q1: 资源文件太大，加载慢？
**A:** 
1. 使用资源压缩
2. 采用远程加载 + 本地缓存策略
3. 只打包常用资源

### Q2: Cocos Creator 资源导入失败？
**A:**
1. 检查文件格式是否支持
2. 检查文件名是否包含特殊字符
3. 尝试刷新资源管理器（右键 → 刷新）

### Q3: 音频在手机上无法播放？
**A:**
1. 检查音频格式（推荐 MP3）
2. 确保在用户交互后播放（浏览器限制）
3. 检查音频文件路径是否正确

### Q4: 图片显示模糊？
**A:**
1. 检查原图分辨率
2. 调整 Sprite 组件的 Trim 设置
3. 设置正确的图片类型（Sprite、Texture 等）

---

## 🔟 总结

### 推荐的资源策略

1. **单词库**：全部打包到本地（体积小，5MB）
2. **音频**：常用单词打包，其他远程加载
3. **图片**：常用单词打包，其他远程加载
4. **配置**：全部打包到本地

### 预期效果

- **初始包体积**：< 50MB（不含全部音频图片）
- **首次加载时间**：< 10秒
- **游戏流畅度**：60 FPS
- **资源加载成功率**：> 95%

---

**资源迁移完成！** ✅

下一步：阅读 [05_核心逻辑迁移.md](./05_核心逻辑迁移.md)




